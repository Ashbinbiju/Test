<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tax Report Analyzer - Retail Cloud</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background-color: #fff;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .header p {
            color: #7f8c8d;
        }

        .main-content {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 20px;
        }

        .sidebar {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            height: fit-content;
        }

        .content {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .section {
            margin-bottom: 25px;
        }

        .section h2 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 500;
        }

        input[type="text"],
        input[type="date"],
        input[type="datetime-local"],
        select,
        textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        textarea {
            resize: vertical;
            min-height: 100px;
            font-family: monospace;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #3498db;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background-color 0.3s;
        }

        .btn-primary {
            background-color: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background-color: #2980b9;
        }

        .btn-success {
            background-color: #27ae60;
            color: white;
            width: 100%;
        }

        .btn-success:hover {
            background-color: #229954;
        }

        .btn-danger {
            background-color: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background-color: #c0392b;
        }

        .btn-secondary {
            background-color: #95a5a6;
            color: white;
            margin-left: 10px;
        }

        .btn-secondary:hover {
            background-color: #7f8c8d;
        }

        .domain-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            margin-top: 10px;
        }

        .domain-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin-bottom: 10px;
            background-color: #f8f9fa;
            border-radius: 4px;
            border: 1px solid #e9ecef;
            cursor: pointer;
        }

        .domain-item:hover {
            background-color: #e9ecef;
        }

        .domain-item.active {
            background-color: #e3f2fd;
            border-color: #3498db;
        }

        .domain-name {
            font-weight: 500;
            color: #2c3e50;
        }

        .results-container {
            margin-top: 20px;
        }

        .result-card {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 4px;
            margin-bottom: 15px;
            border-left: 4px solid #3498db;
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .result-title {
            font-weight: 600;
            color: #2c3e50;
            font-size: 1.1em;
        }

        .status-badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-match {
            background-color: #d4edda;
            color: #155724;
        }

        .status-mismatch {
            background-color: #f8d7da;
            color: #721c24;
        }

        .status-warning {
            background-color: #fff3cd;
            color: #856404;
        }

        .result-details {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .detail-item {
            text-align: center;
            padding: 15px;
            background-color: #fff;
            border-radius: 4px;
            border: 1px solid #e9ecef;
        }

        .detail-label {
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 5px;
            text-transform: uppercase;
        }

        .detail-value {
            font-size: 20px;
            font-weight: 600;
            color: #2c3e50;
        }

        .detail-sub {
            font-size: 14px;
            color: #7f8c8d;
            margin-top: 5px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background-color: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 15px;
            border: 1px solid #f5c6cb;
        }

        .info-message {
            background-color: #d1ecf1;
            color: #0c5460;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 15px;
            border: 1px solid #bee5eb;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: #fff;
            margin: 5% auto;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #000;
        }

        .discrepancy-details {
            background-color: #fff5f5;
            padding: 15px;
            border-radius: 4px;
            margin-top: 15px;
            border: 1px solid #ffdddd;
        }

        .discrepancy-item {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr;
            gap: 10px;
            padding: 10px;
            border-bottom: 1px solid #ffdddd;
            align-items: center;
        }

        .discrepancy-item:last-child {
            border-bottom: none;
        }

        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .comparison-table th,
        .comparison-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .comparison-table th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
        }

        .comparison-table tr:hover {
            background-color: #f8f9fa;
        }

        .highlight-mismatch {
            background-color: #fff5f5 !important;
            color: #e74c3c;
        }

        .filter-section {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 15px;
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .result-details {
                grid-template-columns: 1fr;
            }

            .filter-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Tax Report Analyzer</h1>
            <p>Compare Tax Reports, Tender Reports, and Sales Summary across multiple domains</p>
        </div>

        <div class="main-content">
            <div class="sidebar">
                <div class="section">
                    <h2>Domain Management</h2>
                    <button class="btn btn-primary" onclick="openAddDomainModal()">Add Domain</button>
                    <div class="domain-list" id="domainList">
                        <!-- Domains will be populated here -->
                    </div>
                </div>

                <div class="section">
                    <h2>Analysis Settings</h2>
                    <div class="form-group">
                        <label for="domainSelect">Select Domain</label>
                        <select id="domainSelect" onchange="updateSelectedDomain()">
                            <option value="">Select a domain</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="startDate">Start Date</label>
                        <input type="date" id="startDate">
                    </div>
                    <div class="form-group">
                        <label for="endDate">End Date</label>
                        <input type="date" id="endDate">
                    </div>
                    
                    <div class="filter-section">
                        <h3 style="font-size: 1em; margin-bottom: 10px;">Filters (Optional)</h3>
                        <div class="filter-grid">
                            <div class="form-group" style="margin-bottom: 10px;">
                                <label for="venueFilter" style="font-size: 12px;">Venue</label>
                                <select id="venueFilter" style="font-size: 12px; padding: 5px;">
                                    <option value="">All Venues</option>
                                </select>
                            </div>
                            <div class="form-group" style="margin-bottom: 10px;">
                                <label for="storeFilter" style="font-size: 12px;">Store</label>
                                <select id="storeFilter" style="font-size: 12px; padding: 5px;">
                                    <option value="">All Stores</option>
                                </select>
                            </div>
                            <div class="form-group" style="margin-bottom: 10px;">
                                <label for="registerFilter" style="font-size: 12px;">Register</label>
                                <select id="registerFilter" style="font-size: 12px; padding: 5px;">
                                    <option value="">All Registers</option>
                                </select>
                            </div>
                            <div class="form-group" style="margin-bottom: 10px;">
                                <label for="eventFilter" style="font-size: 12px;">Event</label>
                                <select id="eventFilter" style="font-size: 12px; padding: 5px;">
                                    <option value="">All Events</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <button class="btn btn-success" onclick="analyzeReports()">Analyze Reports</button>
                </div>

                <div class="section">
                    <h2>Quick Actions</h2>
                    <button class="btn btn-secondary" style="width: 100%; margin-bottom: 10px;" onclick="exportResults()">Export Results</button>
                    <button class="btn btn-secondary" style="width: 100%;" onclick="clearHistory()">Clear History</button>
                </div>
            </div>

            <div class="content">
                <h2>Analysis Results</h2>
                <div id="resultsContainer" class="results-container">
                    <div class="info-message">
                        Select a domain and date range to begin analysis. The system will compare:
                        <ul style="margin-top: 10px; margin-left: 20px;">
                            <li>Tax Report totals and calculations</li>
                            <li>Tender Report payment summaries</li>
                            <li>Sales Summary aggregations</li>
                        </ul>
                    </div>
                </div>            </div>
        </div>
    </div>

    <!-- Add Domain Modal -->
    <div id="addDomainModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeAddDomainModal()">&times;</span>
            <h2>Add New Domain</h2>
            <div class="form-group">
                <label for="domainName">Domain Name</label>
                <input type="text" id="domainName" placeholder="e.g., JV">
            </div>
            <div class="form-group">
                <label for="domainToken">Authorization Token</label>
                <textarea id="domainToken" placeholder="Bearer AAAAewAH..."></textarea>
            </div>
            <div class="form-group">
                <label for="apiBaseUrl">API Base URL</label>
                <input type="text" id="apiBaseUrl" value="https://betaaccount.retailcloud.com" placeholder="https://betaaccount.retailcloud.com">
            </div>
            <button class="btn btn-primary" onclick="addDomain()">Add Domain</button>
        </div>
    </div>

    <script>
        // Configuration
        const API_CONFIG = {
            endpoints: {
                tax: '/analytics/taxes',
                sales: '/analytics/sales',
                venues: '/console/business/venues',
                stores: '/console/business/stores',
                registers: '/console/business/registers',
                reportingGroups: '/console/business/reporting/groups',
                events: '/console/entertainments/events'
            },
            headers: {
                'Content-Type': 'application/json',
                'X-Client-Request-ID': generateUUID(),
                'X-Trace-ID': generateUUID(),
                'X-Trace-Path': 'ConsoleMiddleware'
            }
        };

        // Domain management
        let domains = JSON.parse(localStorage.getItem('taxAnalyzerDomains')) || [];
        let currentDomain = null;
        let analysisHistory = JSON.parse(localStorage.getItem('taxAnalyzerHistory')) || [];
        let filterOptions = {
            venues: [],
            stores: [],
            registers: [],
            events: []
        };

        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        function saveDomains() {
            localStorage.setItem('taxAnalyzerDomains', JSON.stringify(domains));
        }

        function saveHistory() {
            localStorage.setItem('taxAnalyzerHistory', JSON.stringify(analysisHistory));
        }

        function renderDomains() {
            const domainList = document.getElementById('domainList');
            const domainSelect = document.getElementById('domainSelect');
            domainList.innerHTML = '';
            domainSelect.innerHTML = '<option value="">Select a domain</option>';
            
            domains.forEach((domain, index) => {
                // Domain list item
                const domainItem = document.createElement('div');
                domainItem.className = `domain-item ${currentDomain === index ? 'active' : ''}`;
                domainItem.innerHTML = `
                    <span class="domain-name" onclick="selectDomain(${index})">${domain.name}</span>
                    <button class="btn btn-danger" onclick="removeDomain(${index})">Remove</button>
                `;
                domainList.appendChild(domainItem);
                
                // Domain select option
                const option = document.createElement('option');
                option.value = index;
                option.textContent = domain.name;
                if (currentDomain === index) {
                    option.selected = true;
                }
                domainSelect.appendChild(option);
            });
        }

        function selectDomain(index) {
            currentDomain = index;
            document.getElementById('domainSelect').value = index;
            renderDomains();
            loadFilterOptions();
        }

        function updateSelectedDomain() {
            currentDomain = parseInt(document.getElementById('domainSelect').value);
            renderDomains();
            loadFilterOptions();
        }

        async function loadFilterOptions() {
            if (currentDomain === null || isNaN(currentDomain)) return;
            
            const domain = domains[currentDomain];
            
            try {
                // Load venues
                const venuesResponse = await fetch(`${domain.baseUrl}${API_CONFIG.endpoints.venues}?status=Active`, {
                    headers: {
                        'Authorization': domain.token,
                        'Domain': domain.name
                    }
                });
                if (venuesResponse.ok) {
                    const venues = await venuesResponse.json();
                    updateFilterDropdown('venueFilter', venues.data || venues, 'venueID', 'name');
                }

                // Load stores
                const storesResponse = await fetch(`${domain.baseUrl}${API_CONFIG.endpoints.stores}?status=Active`, {
                    headers: {
                        'Authorization': domain.token,
                        'Domain': domain.name
                    }
                });
                if (storesResponse.ok) {
                    const stores = await storesResponse.json();
                    updateFilterDropdown('storeFilter', stores.data || stores, 'storeID', 'name');
                }

                // Load registers
                const registersResponse = await fetch(`${domain.baseUrl}${API_CONFIG.endpoints.registers}?status=Active`, {
                    headers: {
                        'Authorization': domain.token,
                        'Domain': domain.name
                    }
                });
                if (registersResponse.ok) {
                    const registers = await registersResponse.json();
                    updateFilterDropdown('registerFilter', registers.data || registers, 'registerID', 'name');
                }

                // Load events
                const eventsResponse = await fetch(`${domain.baseUrl}${API_CONFIG.endpoints.events}`, {
                    headers: {
                        'Authorization': domain.token,
                        'Domain': domain.name
                    }
                });
                if (eventsResponse.ok) {
                    const events = await eventsResponse.json();
                    updateFilterDropdown('eventFilter', events.data || events, 'id', 'name');
                }
            } catch (error) {
                console.error('Error loading filter options:', error);
            }
        }

        function updateFilterDropdown(selectId, items, valueField, textField) {
            const select = document.getElementById(selectId);
            const currentValue = select.value;
            select.innerHTML = `<option value="">All ${selectId.replace('Filter', '')}s</option>`;
            
            if (Array.isArray(items)) {
                items.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item[valueField];
                    option.textContent = item[textField];
                    select.appendChild(option);
                });
            }
            
            select.value = currentValue;
        }

        function openAddDomainModal() {
            document.getElementById('addDomainModal').style.display = 'block';
        }

        function closeAddDomainModal() {
            document.getElementById('addDomainModal').style.display = 'none';
            document.getElementById('domainName').value = '';
            document.getElementById('domainToken').value = '';
            document.getElementById('apiBaseUrl').value = 'https://betaaccount.retailcloud.com';
        }

        function addDomain() {
            const name = document.getElementById('domainName').value.trim();
            const token = document.getElementById('domainToken').value.trim();
            const baseUrl = document.getElementById('apiBaseUrl').value.trim();
            
            if (!name || !token) {
                alert('Please enter both domain name and token');
                return;
            }
            
            domains.push({
                name: name,
                token: token,
                baseUrl: baseUrl || 'https://betaaccount.retailcloud.com'
            });
            
            saveDomains();
            renderDomains();
            closeAddDomainModal();
        }

        function removeDomain(index) {
            if (confirm('Are you sure you want to remove this domain?')) {
                domains.splice(index, 1);
                if (currentDomain === index) {
                    currentDomain = null;
                }
                saveDomains();
                renderDomains();
            }
        }

        // Convert date to Unix timestamp
        function dateToUnixTimestamp(dateString) {
            return Math.floor(new Date(dateString).getTime() / 1000);
        }

        // Format Unix timestamp to readable date
        function formatTimestamp(timestamp) {
            return new Date(timestamp * 1000).toLocaleString();
        }

        // Format currency
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD'
            }).format(amount || 0);
        }

        // Calculate percentage difference
        function calculatePercentageDiff(value1, value2) {
            if (value2 === 0) return 0;
            return ((value1 - value2) / value2 * 100).toFixed(2);
        }

        async function analyzeReports() {
            const domainIndex = document.getElementById('domainSelect').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            if (!domainIndex || !startDate || !endDate) {
                alert('Please select a domain and date range');
                return;
            }
            
            const domain = domains[domainIndex];
            const resultsContainer = document.getElementById('resultsContainer');
            
            // Show loading
            resultsContainer.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Analyzing reports for ${domain.name}...</p>
                </div>
            `;
            
            try {
                // Convert dates to Unix timestamps
                const startTimestamp = dateToUnixTimestamp(startDate);
                const endTimestamp = dateToUnixTimestamp(endDate + 'T23:59:59');
                
                // Get filter values
                const filters = {
                    venueID: document.getElementById('venueFilter').value ? [parseInt(document.getElementById('venueFilter').value)] : [],
                    storeID: document.getElementById('storeFilter').value ? [parseInt(document.getElementById('storeFilter').value)] : [],
                    registerID: document.getElementById('registerFilter').value ? [parseInt(document.getElementById('registerFilter').value)] : [],
                    eventID: document.getElementById('eventFilter').value ? [parseInt(document.getElementById('eventFilter').value)] : []
                };
                
                // Fetch all reports
                const [taxData, salesData, tenderData] = await Promise.all([
                    fetchTaxReport(domain, startTimestamp, endTimestamp, filters),
                    fetchSalesReport(domain, startTimestamp, endTimestamp, filters),
                    fetchTenderReport(domain, startTimestamp, endTimestamp, filters)
                ]);
                
                // Analyze and display results
                const analysis = analyzeData(taxData, tenderData, salesData);
                displayResults(domain.name, startDate, endDate, analysis);
                
                // Save to history
                analysisHistory.unshift({
                    domain: domain.name,
                    startDate: startDate,
                    endDate: endDate,
                    timestamp: new Date().toISOString(),
                    results: analysis,
                    filters: filters
                });
                
                // Keep only last 50 analyses
                if (analysisHistory.length > 50) {
                    analysisHistory = analysisHistory.slice(0, 50);
                }
                saveHistory();
                
            } catch (error) {
                resultsContainer.innerHTML = `
                    <div class="error-message">
                        <strong>Error:</strong> ${error.message}
                        <br><br>
                        <details>
                            <summary>Technical Details</summary>
                            <pre>${error.stack}</pre>
                        </details>
                    </div>
                `;
            }
        }

        async function fetchTaxReport(domain, startTimestamp, endTimestamp, filters) {
            const requestBody = {
                interval: [{
                    startDate: startTimestamp,
                    endDate: endTimestamp
                }],
                venueID: filters.venueID || [],
                storeID: filters.storeID || [],
                registerID: filters.registerID || [],
                reportingGroupID: [],
                eventID: filters.eventID || []
            };
            
            const response = await fetch(`${domain.baseUrl}${API_CONFIG.endpoints.tax}?=null`, {
                method: 'POST',
                headers: {
                    ...API_CONFIG.headers,
                    'Authorization': domain.token,
                    'Domain': domain.name,
                    'Data-Grouping': 'TAX,STORE,TAX_EXEMPT,EVENT',
                    'DATA-SUMMARY': 'true',
                    'Expand': 'EVENT'
                },
                body: JSON.stringify(requestBody)
            });
            
            if (!response.ok) {
                throw new Error(`Tax Report API failed: ${response.status} ${response.statusText}`);
            }
            
            return await response.json();
        }

        async function fetchSalesReport(domain, startTimestamp, endTimestamp, filters) {
            const requestBody = {
                interval: [{
                    startDate: startTimestamp,
                    endDate: endTimestamp
                }],
                venueID: filters.venueID || [],
                storeID: filters.storeID || [],
                registerID: filters.registerID || [],
                reportingGroupID: [],
                eventID: filters.eventID || [],
                period: "DAY",
                virtualStore: true
            };
            
            const response = await fetch(`${domain.baseUrl}${API_CONFIG.endpoints.sales}?`, {
                method: 'POST',
                headers: {
                    ...API_CONFIG.headers,
                    'Authorization': domain.token,
                    'Domain': domain.name,
                    'Data-Grouping': 'STORE,EVENT',
                    'DATA-SUMMARY': 'true',
                    'Expand': 'EVENT'
                },
                body: JSON.stringify(requestBody)
            });
            
            if (!response.ok) {
                throw new Error(`Sales Report API failed: ${response.status} ${response.statusText}`);
            }
            
            return await response.json();
        }

        async function fetchTenderReport(domain, startTimestamp, endTimestamp, filters) {
            const requestBody = {
                interval: [{
                    startDate: startTimestamp,
                    endDate: endTimestamp
                }],
                venueID: filters.venueID || [],
                storeID: filters.storeID || [],
                registerID: filters.registerID || [],
                reportingGroupID: [],
                eventID: filters.eventID || [],
                period: "DAY",
                virtualStore: true
            };
            
            const response = await fetch(`${domain.baseUrl}${API_CONFIG.endpoints.sales}?=null`, {
                method: 'POST',
                headers: {
                    ...API_CONFIG.headers,
                    'Authorization': domain.token,
                    'Domain': domain.name,
                    'Data-Grouping': 'STORE,REGISTER,VENUE,EVENT',
                    'DATA-SUMMARY': 'true',
                    'Expand': 'PAYMENT,EVENT'
                },
                body: JSON.stringify(requestBody)
            });
            
            if (!response.ok) {
                throw new Error(`Tender Report API failed: ${response.status} ${response.statusText}`);
            }
            
            return await response.json();
        }

        function analyzeData(taxData, tenderData, salesData) {            // Extract totals from each report
            const taxTotal = extractTaxTotal(taxData);
            const tenderTotal = extractTenderTotal(tenderData);
            const salesTotal = extractSalesTotal(salesData);
            
            // Calculate discrepancies
            const discrepancies = [];
            
            // Compare net sales across reports
            if (Math.abs(taxTotal.netSales - salesTotal.netSales) > 0.01) {
                discrepancies.push({
                    type: 'Net Sales: Tax vs Sales',
                    source: 'Tax Report',
                    sourceValue: taxTotal.netSales,
                    target: 'Sales Summary',
                    targetValue: salesTotal.netSales,
                    difference: taxTotal.netSales - salesTotal.netSales,
                    percentage: calculatePercentageDiff(taxTotal.netSales, salesTotal.netSales)
                });
            }
            
            if (Math.abs(tenderTotal.grossSales - salesTotal.grossSales) > 0.01) {
                discrepancies.push({
                    type: 'Gross Sales: Tender vs Sales',
                    source: 'Tender Report',
                    sourceValue: tenderTotal.grossSales,
                    target: 'Sales Summary',
                    targetValue: salesTotal.grossSales,
                    difference: tenderTotal.grossSales - salesTotal.grossSales,
                    percentage: calculatePercentageDiff(tenderTotal.grossSales, salesTotal.grossSales)
                });
            }
            
            // Compare tax amounts
            if (Math.abs(taxTotal.totalTax - salesTotal.totalTax) > 0.01) {
                discrepancies.push({
                    type: 'Total Tax: Tax vs Sales',
                    source: 'Tax Report',
                    sourceValue: taxTotal.totalTax,
                    target: 'Sales Summary',
                    targetValue: salesTotal.totalTax,
                    difference: taxTotal.totalTax - salesTotal.totalTax,
                    percentage: calculatePercentageDiff(taxTotal.totalTax, salesTotal.totalTax)
                });
            }
            
            return {
                taxReport: taxTotal,
                tenderReport: tenderTotal,
                salesSummary: salesTotal,
                discrepancies: discrepancies,
                rawData: {
                    tax: taxData,
                    tender: tenderData,
                    sales: salesData
                }
            };
        }

        function extractTaxTotal(data) {
            const result = {
                netSales: 0,
                totalTax: 0,
                unitsSold: 0,
                nonTaxable: {
                    netSales: 0,
                    totalTax: 0,
                    unitsSold: 0
                },
                taxable: {
                    netSales: 0,
                    totalTax: 0,
                    unitsSold: 0,
                    tax1: { rate: 0, totalTax: 0 },
                    tax2: { rate: 0, totalTax: 0 }
                }
            };
            
            if (data && data.firstInterval && data.firstInterval.summary) {
                const summary = data.firstInterval.summary;
                
                // Non-taxable
                if (summary.nonTaxable) {
                    result.nonTaxable.netSales = summary.nonTaxable.netSales || 0;
                    result.nonTaxable.totalTax = summary.nonTaxable.totalTax || 0;
                    result.nonTaxable.unitsSold = summary.nonTaxable.unitSold || 0;
                }
                
                // Taxable
                if (summary.taxable) {
                    result.taxable.netSales = summary.taxable.netSales || 0;
                    result.taxable.totalTax = summary.taxable.totalTax || 0;
                    result.taxable.unitsSold = summary.taxable.unitSold || 0;
                    
                    if (summary.taxable.tax1) {
                        result.taxable.tax1.rate = summary.taxable.tax1.rate || 0;
                        result.taxable.tax1.totalTax = summary.taxable.tax1.totalTax || 0;
                    }
                    
                    if (summary.taxable.tax2) {
                        result.taxable.tax2.rate = summary.taxable.tax2.rate || 0;
                        result.taxable.tax2.totalTax = summary.taxable.tax2.totalTax || 0;
                    }
                }
                
                // Calculate totals
                result.netSales = result.nonTaxable.netSales + result.taxable.netSales;
                result.totalTax = result.taxable.totalTax;
                result.unitsSold = result.nonTaxable.unitsSold + result.taxable.unitsSold;
            }
            
            return result;
        }

        function extractTenderTotal(data) {
            const result = {
                grossSales: 0,
                netSales: 0,
                totalTax: 0,
                totalTransactions: 0,
                unitsSold: 0,
                payments: {
                    tenders: [],
                    cards: []
                }
            };
            
            if (data && data.firstInterval && data.firstInterval.summary) {
                const summary = data.firstInterval.summary;
                
                result.grossSales = parseFloat(summary.grossSales) || 0;
                result.netSales = parseFloat(summary.netSales) || 0;
                result.totalTax = parseFloat(summary.totalTax) || 0;
                result.totalTransactions = parseFloat(summary.totalTransactionCount) || 0;
                result.unitsSold = parseFloat(summary.totalUnitsSold) || 0;
                
                // Extract payment methods
                if (summary.payments) {
                    if (summary.payments.tenders) {
                        result.payments.tenders = summary.payments.tenders;
                    }
                    if (summary.payments.cards) {
                        result.payments.cards = summary.payments.cards;
                    }
                }
            }
            
            return result;
        }

        function extractSalesTotal(data) {
            const result = {
                grossSales: 0,
                netSales: 0,
                totalSales: 0,
                totalTax: 0,
                totalTransactions: 0,
                unitsSold: 0,
                cogs: 0,
                marginAmount: 0,
                marginPercentage: 0,
                averageSalesPerDay: 0,
                averageUnitPerTransaction: 0,
                averageAmountPerTransaction: 0
            };
            
            if (data && data.firstInterval && data.firstInterval.summary) {
                const summary = data.firstInterval.summary;
                
                result.grossSales = parseFloat(summary.grossSales) || 0;
                result.netSales = parseFloat(summary.netSales) || 0;
                result.totalSales = parseFloat(summary.totalSales) || 0;
                result.totalTax = parseFloat(summary.totalTax) || 0;
                result.totalTransactions = parseFloat(summary.totalTransactionCount) || 0;
                result.unitsSold = parseFloat(summary.totalUnitsSold) || 0;
                result.cogs = parseFloat(summary.cogs) || 0;
                result.marginAmount = parseFloat(summary.marginAmount) || 0;
                result.marginPercentage = parseFloat(summary.marginPercentage) || 0;
                result.averageSalesPerDay = parseFloat(summary.averageSalesPerDay) || 0;
                result.averageUnitPerTransaction = parseFloat(summary.averageUnitPerTransaction) || 0;
                result.averageAmountPerTransaction = parseFloat(summary.averageAmountPerTransaction) || 0;
            }
            
            return result;
        }

        function displayResults(domainName, startDate, endDate, analysis) {
    const resultsContainer = document.getElementById('resultsContainer');
    const hasDiscrepancies = analysis.discrepancies.length > 0;

    // Calculate Net Sales Breakdown
    const taxNetSalesTaxable = analysis.taxReport.taxable.netSales;
    const taxNetSalesNonTaxable = analysis.taxReport.nonTaxable.netSales;
    const taxNetSalesTotal = taxNetSalesTaxable + taxNetSalesNonTaxable;
    const salesNetSales = analysis.salesSummary.netSales;
    const tenderNetSales = analysis.tenderReport.netSales;
    const diff = salesNetSales - taxNetSalesTotal;

    let html = `
        <div class="result-card">
            <div class="result-header">
                <div>
                    <div class="result-title">${domainName}</div>
                    <div style="color: #7f8c8d; font-size: 14px;">${startDate} to ${endDate}</div>
                </div>
                <span class="status-badge ${hasDiscrepancies ? 'status-mismatch' : 'status-match'}">
                    ${hasDiscrepancies ? `${analysis.discrepancies.length} Discrepancies Found` : 'All Reports Match'}
                </span>
            </div>
            <div class="result-details">
                <div class="detail-item">
                    <div class="detail-label">Tax Report</div>
                    <div class="detail-value">${formatCurrency(analysis.taxReport.netSales)}</div>
                    <div class="detail-sub">Tax: ${formatCurrency(analysis.taxReport.totalTax)}</div>
                    <div class="detail-sub">Units: ${analysis.taxReport.unitsSold}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Tender Report</div>
                    <div class="detail-value">${formatCurrency(analysis.tenderReport.netSales)}</div>
                    <div class="detail-sub">Tax: ${formatCurrency(analysis.tenderReport.totalTax)}</div>
                    <div class="detail-sub">Transactions: ${analysis.tenderReport.totalTransactions}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Sales Summary</div>
                    <div class="detail-value">${formatCurrency(analysis.salesSummary.netSales)}</div>
                    <div class="detail-sub">Tax: ${formatCurrency(analysis.salesSummary.totalTax)}</div>
                    <div class="detail-sub">Transactions: ${analysis.salesSummary.totalTransactions}</div>
                </div>
            </div>
        </div>
    `;

    // Detailed Breakdown Table
    html += `
        <div class="result-card">
            <h3 style="margin-bottom: 15px;">Detailed Breakdown</h3>
            <table class="comparison-table">
                <thead>
                    <tr>
                        <th>Metric</th>
                        <th>Tax Report</th>
                        <th>Tender Report</th>
                        <th>Sales Summary</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>Net Sales</strong></td>
                        <td>${formatCurrency(analysis.taxReport.netSales)}</td>
                        <td>${formatCurrency(analysis.tenderReport.netSales)}</td>
                        <td>${formatCurrency(analysis.salesSummary.netSales)}</td>
                    </tr>
                    <tr>
                        <td><strong>Gross Sales</strong></td>
                        <td>-</td>
                        <td>${formatCurrency(analysis.tenderReport.grossSales)}</td>
                        <td>${formatCurrency(analysis.salesSummary.grossSales)}</td>
                    </tr>
                    <tr>
                        <td><strong>Total Tax</strong></td>
                        <td>${formatCurrency(analysis.taxReport.totalTax)}</td>
                        <td>${formatCurrency(analysis.tenderReport.totalTax)}</td>
                        <td>${formatCurrency(analysis.salesSummary.totalTax)}</td>
                    </tr>
                    <tr>
                        <td><strong>Units Sold</strong></td>
                        <td>${analysis.taxReport.unitsSold}</td>
                        <td>${analysis.tenderReport.unitsSold}</td>
                        <td>${analysis.salesSummary.unitsSold}</td>
                    </tr>
                    <tr>
                        <td><strong>Transaction Count</strong></td>
                        <td>-</td>
                        <td>${analysis.tenderReport.totalTransactions}</td>
                        <td>${analysis.salesSummary.totalTransactions}</td>
                    </tr>
                </tbody>
            </table>
        </div>
    `;

    // Net Sales Breakdown Table
    html += `
        <div class="result-card">
            <h3 style="margin-bottom: 15px;">Net Sales Breakdown</h3>
            <table class="comparison-table">
                <thead>
                    <tr>
                        <th>Metric</th>
                        <th>Amount</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Tax Report Net Sales (Taxable)</td>
                        <td>${formatCurrency(taxNetSalesTaxable)}</td>
                    </tr>
                    <tr>
                        <td>Tax Report Net Sales (Non-Taxable)</td>
                        <td>${formatCurrency(taxNetSalesNonTaxable)}</td>
                    </tr>
                    <tr>
                        <td><strong>Tax Report Net Sales (Total)</strong></td>
                        <td><strong>${formatCurrency(taxNetSalesTotal)}</strong></td>
                    </tr>
                    <tr>
                        <td>Sales Summary Net Sales</td>
                        <td>${formatCurrency(salesNetSales)}</td>
                    </tr>
                    <tr>
                        <td>Tender Report Net Sales</td>
                        <td>${formatCurrency(tenderNetSales)}</td>
                    </tr>
                    <tr style="background:#fff5f5; color:#e74c3c;">
                        <td><strong>Difference (Sales Summary - Tax Report Total)</strong></td>
                        <td><strong>${formatCurrency(diff)}</strong></td>
                    </tr>
                </tbody>
            </table>
            <div style="margin-top:10px; color:#888;">
                ${
                    Math.abs(diff) < 0.05
                    ? "Note: The difference is due to rounding or minor calculation differences."
                    : Math.abs(diff - taxNetSalesNonTaxable) < 0.05
                        ? "Note: The difference equals the non-taxable sales. Sales Summary and Tender Report include non-taxable sales, while the Tax Report (Taxable) does not."
                        : "Note: Please review your filters and data for discrepancies."
                }
            </div>
        </div>
    `;

    // Tax Breakdown Table
    if (analysis.taxReport.taxable.tax1.totalTax > 0 || analysis.taxReport.taxable.tax2.totalTax > 0) {
        html += `
            <div class="result-card">
                <h3 style="margin-bottom: 15px;">Tax Breakdown</h3>
                <table class="comparison-table">
                    <thead>
                        <tr>
                            <th>Tax Type</th>
                            <th>Rate</th>
                            <th>Tax Amount</th>
                            <th>Net Sales</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>Non-Taxable Sales</strong></td>
                            <td>0%</td>
                            <td>${formatCurrency(analysis.taxReport.nonTaxable.totalTax)}</td>
                            <td>${formatCurrency(analysis.taxReport.nonTaxable.netSales)}</td>
                        </tr>
                        ${analysis.taxReport.taxable.tax1.totalTax > 0 ? `
                        <tr>
                            <td><strong>Tax 1 (State Excise)</strong></td>
                            <td>${analysis.taxReport.taxable.tax1.rate}%</td>
                            <td>${formatCurrency(analysis.taxReport.taxable.tax1.totalTax)}</td>
                            <td rowspan="2">${formatCurrency(analysis.taxReport.taxable.netSales)}</td>
                        </tr>
                        ` : ''}
                        ${analysis.taxReport.taxable.tax2.totalTax > 0 ? `
                        <tr>
                            <td><strong>Tax 2 (VAT)</strong></td>
                            <td>${analysis.taxReport.taxable.tax2.rate}%</td>
                            <td>${formatCurrency(analysis.taxReport.taxable.tax2.totalTax)}</td>
                        </tr>
                        ` : ''}
                    </tbody>
                </table>
            </div>
        `;
    }

    // Payment Methods Table
    if (analysis.tenderReport.payments.tenders.length > 0) {
        html += `
            <div class="result-card">
                <h3 style="margin-bottom: 15px;">Payment Methods</h3>
                <table class="comparison-table">
                    <thead>
                        <tr>
                            <th>Payment Type</th>
                            <th>Transactions</th>
                            <th>Total Amount</th>
                            <th>Average</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${analysis.tenderReport.payments.tenders.map(tender => `
                            <tr>
                                <td><strong>${tender.type}</strong></td>
                                <td>${tender.totalTransaction}</td>
                                <td>${formatCurrency(tender.totalTransactionsAmount)}</td>
                                <td>${formatCurrency(tender.averageTransactionAmount)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
    }

    // Discrepancy Details Table
    if (hasDiscrepancies) {
        html += `
            <div class="result-card" style="border-left-color: #e74c3c;">
                <h3 style="color: #e74c3c; margin-bottom: 15px;">Discrepancy Details</h3>
                <table class="comparison-table">
                    <thead>
                        <tr>
                            <th>Comparison</th>
                            <th>Source Value</th>
                            <th>Target Value</th>
                            <th>Difference</th>
                            <th>Percentage</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${analysis.discrepancies.map(disc => `
                            <tr class="highlight-mismatch">
                                <td><strong>${disc.type}</strong></td>
                                <td>${formatCurrency(disc.sourceValue)}</td>
                                <td>${formatCurrency(disc.targetValue)}</td>
                                <td>${formatCurrency(Math.abs(disc.difference))}</td>
                                <td>${disc.percentage}%</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
    }

    // Action Buttons
    html += `
        <div style="margin-top: 20px;">
            <button class="btn btn-primary" onclick="downloadDetailedReport('${domainName}', '${startDate}', '${endDate}')">
                Download Detailed Report
            </button>
            <button class="btn btn-secondary" onclick="viewRawData()">
                View Raw Data
            </button>
            <button class="btn btn-secondary" onclick="compareWithHistory()">
                Compare with History
            </button>
        </div>
    `;

    resultsContainer.innerHTML = html;

    // Store current analysis for raw data viewing
    window.currentAnalysis = analysis;
}

        function viewRawData() {
            if (!window.currentAnalysis) return;
            
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 800px;">
                    <span class="close" onclick="this.parentElement.parentElement.remove()">&times;</span>
                    <h2>Raw API Response Data</h2>
                    
                    <h3 style="margin-top: 20px;">Tax Report Response</h3>
                    <pre style="background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; max-height: 200px;">
${JSON.stringify(window.currentAnalysis.rawData.tax, null, 2)}
                    </pre>
                    
                    <h3 style="margin-top: 20px;">Tender Report Response</h3>
                    <pre style="background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; max-height: 200px;">
${JSON.stringify(window.currentAnalysis.rawData.tender, null, 2)}
                    </pre>
                    
                    <h3 style="margin-top: 20px;">Sales Summary Response</h3>
                    <pre style="background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; max-height: 200px;">
${JSON.stringify(window.currentAnalysis.rawData.sales, null, 2)}
                    </pre>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function compareWithHistory() {
            if (analysisHistory.length < 2) {
                alert('Not enough history data to compare. Run at least 2 analyses first.');
                return;
            }
            
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            
            let historyHtml = `
                <div class="modal-content" style="max-width: 900px;">
                    <span class="close" onclick="this.parentElement.parentElement.remove()">&times;</span>
                    <h2>Historical Comparison</h2>
                    <table class="comparison-table" style="margin-top: 20px;">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Domain</th>
                                <th>Period</th>
                                <th>Net Sales</th>
                                <th>Total Tax</th>
                                <th>Discrepancies</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            analysisHistory.slice(0, 10).forEach((item, index) => {
                const hasDiscrepancies = item.results.discrepancies.length > 0;
                historyHtml += `
                    <tr>
                        <td>${new Date(item.timestamp).toLocaleDateString()}</td>
                        <td>${item.domain}</td>
                        <td>${item.startDate} to ${item.endDate}</td>
                        <td>${formatCurrency(item.results.salesSummary.netSales)}</td>
                        <td>${formatCurrency(item.results.salesSummary.totalTax)}</td>
                        <td>
                            <span class="status-badge ${hasDiscrepancies ? 'status-mismatch' : 'status-match'}">
                                ${hasDiscrepancies ? item.results.discrepancies.length : 'None'}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-primary" style="padding: 5px 10px; font-size: 12px;" 
                                    onclick="viewHistoricalAnalysis(${index})">View</button>
                        </td>
                    </tr>
                `;
            });
            
            historyHtml += `
                        </tbody>
                    </table>
                </div>
            `;
            
            modal.innerHTML = historyHtml;
            document.body.appendChild(modal);
        }

        function viewHistoricalAnalysis(index) {
            const historicalData = analysisHistory[index];
            if (!historicalData) return;
            
            // Close any open modals
            document.querySelectorAll('.modal').forEach(modal => modal.remove());
            
            // Display the historical analysis
            displayResults(
                historicalData.domain,
                historicalData.startDate,
                historicalData.endDate,
                historicalData.results
            );
        }

        function downloadDetailedReport(domainName, startDate, endDate) {
            if (!window.currentAnalysis) return;
            
            const analysis = window.currentAnalysis;
            const timestamp = new Date().toISOString();
            
            // Generate CSV content
            let csvContent = `Tax Analysis Report\n`;
            csvContent += `Domain: ${domainName}\n`;
            csvContent += `Period: ${startDate} to ${endDate}\n`;
            csvContent += `Generated: ${timestamp}\n\n`;
            
            csvContent += `Summary\n`;
            csvContent += `Report Type,Net Sales,Gross Sales,Total Tax,Units Sold,Transaction Count\n`;
            csvContent += `Tax Report,${analysis.taxReport.netSales},N/A,${analysis.taxReport.totalTax},${analysis.taxReport.unitsSold},N/A\n`;
            csvContent += `Tender Report,${analysis.tenderReport.netSales},${analysis.tenderReport.grossSales},${analysis.tenderReport.totalTax},${analysis.tenderReport.unitsSold},${analysis.tenderReport.totalTransactions}\n`;
            csvContent += `Sales Summary,${analysis.salesSummary.netSales},${analysis.salesSummary.grossSales},${analysis.salesSummary.totalTax},${analysis.salesSummary.unitsSold},${analysis.salesSummary.totalTransactions}\n\n`;
            
            // Add tax breakdown
            csvContent += `Tax Breakdown\n`;
            csvContent += `Category,Net Sales,Tax Amount,Units Sold\n`;
            csvContent += `Non-Taxable,${analysis.taxReport.nonTaxable.netSales},${analysis.taxReport.nonTaxable.totalTax},${analysis.taxReport.nonTaxable.unitsSold}\n`;
            csvContent += `Taxable,${analysis.taxReport.taxable.netSales},${analysis.taxReport.taxable.totalTax},${analysis.taxReport.taxable.unitsSold}\n`;
            if (analysis.taxReport.taxable.tax1.totalTax > 0) {
                csvContent += `Tax 1 (${analysis.taxReport.taxable.tax1.rate}%),N/A,${analysis.taxReport.taxable.tax1.totalTax},N/A\n`;
            }
            if (analysis.taxReport.taxable.tax2.totalTax > 0) {
                csvContent += `Tax 2 (${analysis.taxReport.taxable.tax2.rate}%),N/A,${analysis.taxReport.taxable.tax2.totalTax},N/A\n`;
            }
            csvContent += `\n`;
            
            // Add payment methods
            if (analysis.tenderReport.payments.tenders.length > 0) {
                csvContent += `Payment Methods\n`;
                csvContent += `Type,Transactions,Total Amount,Average Amount\n`;
                analysis.tenderReport.payments.tenders.forEach(tender => {
                    csvContent += `${tender.type},${tender.totalTransaction},${tender.totalTransactionsAmount},${tender.averageTransactionAmount}\n`;
                });
                csvContent += `\n`;
            }
            
            // Add discrepancies
            if (analysis.discrepancies.length > 0) {
                csvContent += `Discrepancies\n`;
                csvContent += `Type,Source,Source Value,Target,Target Value,Difference,Percentage\n`;
                analysis.discrepancies.forEach(disc => {
                    csvContent += `${disc.type},${disc.source},${disc.sourceValue},${disc.target},${disc.targetValue},${disc.difference},${disc.percentage}%\n`;
                });
            } else {
                csvContent += `No discrepancies found - all reports match\n`;
            }
            
            // Create and download file
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `tax-analysis-${domainName}-${startDate}-${endDate}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        function exportResults() {
            if (analysisHistory.length === 0) {
                alert('No analysis history to export');
                return;
            }
            
            const exportData = {
                exportDate: new Date().toISOString(),
                domains: domains.map(d => ({ name: d.name, baseUrl: d.baseUrl })),
                analysisHistory: analysisHistory
            };
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `tax-analyzer-export-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        function clearHistory() {
            if (confirm('Are you sure you want to clear all analysis history?')) {
                analysisHistory = [];
                saveHistory();
                alert('History cleared successfully');
            }
        }

        // Set default dates on load
        window.onload = function() {
            const today = new Date();
            const thirtyDaysAgo = new Date(today);
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            
            document.getElementById('endDate').value = today.toISOString().split('T')[0];
            document.getElementById('startDate').value = thirtyDaysAgo.toISOString().split('T')[0];
            
            renderDomains();
            
            // Add example domain if none exist
            if (domains.length === 0 && window.location.hostname === 'localhost') {
                domains.push({
                    name: 'JV',
                    token: 'Bearer AAAAewAHdGVtcC12MV1DVFMPJ4bbfqd4QUJ7MlcAYOdBs2fj5u-nhaW35rXRdjd2mGbnWGM0XWYw3HKnpDfh69VlJeiT5BBf3IwVL9JMqWN3w8287WdAx9xLjYmXzKLdpnZAp66_DRW8BnalDhIrv2zCgU06GaLR1D1vh33hZQ',
                    baseUrl: 'https://betaaccount.retailcloud.com'
                });
                saveDomains();
                renderDomains();
            }
        };

        // Close modal when clicking outside
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        };

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Ctrl/Cmd + Enter to analyze
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                analyzeReports();
            }
            // Escape to close modals
            if (e.key === 'Escape') {
                document.querySelectorAll('.modal').forEach(modal => {
                    modal.style.display = 'none';
                });
            }
        });

        // Auto-save current state
        window.addEventListener('beforeunload', function() {
            saveDomains();
            saveHistory();
        });

        // Helper function to format large numbers
        function formatNumber(num) {
            return new Intl.NumberFormat('en-US').format(num);
        }

        // Helper function to check if values match within tolerance
        function valuesMatch(val1, val2, tolerance = 0.01) {
            return Math.abs(val1 - val2) <= tolerance;
        }

        // Enhanced error handling
        window.addEventListener('unhandledrejection', function(event) {
            console.error('Unhandled promise rejection:', event.reason);
            const resultsContainer = document.getElementById('resultsContainer');
            if (resultsContainer && resultsContainer.querySelector('.loading')) {
                resultsContainer.innerHTML = `
                    <div class="error-message">
                        <strong>An unexpected error occurred:</strong> ${event.reason}
                    </div>
                `;
            }
        });

        // Add visual feedback for loading states
        function setLoadingState(button, isLoading) {
            if (isLoading) {
                button.disabled = true;
                button.textContent = 'Processing...';
                button.style.opacity = '0.6';
            } else {
                button.disabled = false;
                button.textContent = 'Analyze Reports';
                button.style.opacity = '1';
            }
        }
        // Override analyzeReports to include loading state
        const originalAnalyzeReports = analyzeReports;
        analyzeReports = async function() {
            const button = document.querySelector('.btn-success');
            setLoadingState(button, true);
            try {
                await originalAnalyzeReports();
            } finally {
                setLoadingState(button, false);
            }
        };

        // Add tooltips for better UX
        function addTooltip(element, text) {
            if (element) element.title = text;
        }

        // Initialize tooltips
        document.addEventListener('DOMContentLoaded', function() {
            addTooltip(document.getElementById('startDate'), 'Select the start date for the analysis period');
            addTooltip(document.getElementById('endDate'), 'Select the end date for the analysis period');
            addTooltip(document.getElementById('domainSelect'), 'Choose which domain to analyze');
            // Load filter options if a domain is already selected
            if (typeof currentDomain === 'number' && !isNaN(currentDomain)) {
                loadFilterOptions();
            }
        });

        // Debug mode for development
        const DEBUG = false;
        if (DEBUG) {
            window.taxAnalyzer = {
                domains,
                analysisHistory,
                currentAnalysis: window.currentAnalysis,
                API_CONFIG
            };
        }
    </script>
</body>
</html>
